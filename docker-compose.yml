services:
  # VPN Gateway - All download traffic routes through this
  gluetun:
    image: qmcgaw/gluetun:latest
    container_name: gluetun
    restart: unless-stopped
    cap_add:
      - NET_ADMIN
    devices:
      - /dev/net/tun:/dev/net/tun
    ports:
      - "8080:8080"   # qBittorrent WebUI
      - "6881:6881"   # qBittorrent incoming connections
      - "6881:6881/udp"
      - "8085:8085"   # SABnzbd WebUI
      - "9696:9696"   # Prowlarr WebUI
    volumes:
      - /data/arr/config/gluetun:/gluetun
    environment:
      - VPN_SERVICE_PROVIDER=nordvpn
      - VPN_TYPE=openvpn
      - OPENVPN_USER=${NORDVPN_SERVICE_USER}
      - OPENVPN_PASSWORD=${NORDVPN_SERVICE_PASS}
      - SERVER_COUNTRIES=United States
      - FIREWALL_OUTBOUND_SUBNETS=192.168.0.0/16,172.16.0.0/12,10.0.0.0/8
      - TZ=${TZ}

  # BitTorrent Client (via VPN)
  qbittorrent:
    image: lscr.io/linuxserver/qbittorrent:latest
    container_name: qbittorrent
    restart: unless-stopped
    network_mode: "service:gluetun"
    depends_on:
      - gluetun
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=${TZ}
      - WEBUI_PORT=8080
    volumes:
      - /data/arr/config/qbittorrent:/config
      - /data/arr/downloads:/downloads

  # Usenet Client (via VPN)
  sabnzbd:
    image: lscr.io/linuxserver/sabnzbd:latest
    container_name: sabnzbd
    restart: unless-stopped
    network_mode: "service:gluetun"
    depends_on:
      - gluetun
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=${TZ}
    volumes:
      - /data/arr/config/sabnzbd:/config
      - /data/arr/downloads:/downloads

  # Indexer Management (via VPN)
  prowlarr:
    image: lscr.io/linuxserver/prowlarr:latest
    container_name: prowlarr
    restart: unless-stopped
    network_mode: "service:gluetun"
    depends_on:
      - gluetun
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=${TZ}
    volumes:
      - /data/arr/config/prowlarr:/config

  # TV Show Management (Host Network)
  sonarr:
    image: lscr.io/linuxserver/sonarr:latest
    container_name: sonarr
    restart: unless-stopped
    ports:
      - "8989:8989"
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=${TZ}
    volumes:
      - /data/arr/config/sonarr:/config
      - /data/arr/downloads:/downloads
      - /data/arr/media/tv:/tv

  # Movie Management (Host Network)
  radarr:
    image: lscr.io/linuxserver/radarr:latest
    container_name: radarr
    restart: unless-stopped
    ports:
      - "7878:7878"
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=${TZ}
    volumes:
      - /data/arr/config/radarr:/config
      - /data/arr/downloads:/downloads
      - /data/arr/media/movies:/movies

  # Book Management
  readarr:
    image: ghcr.io/hotio/readarr:latest
    container_name: readarr
    restart: unless-stopped
    ports:
      - "8787:8787"
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=${TZ}
    volumes:
      - /data/arr/config/readarr:/config
      - /data/arr/downloads:/downloads
      - /data/arr/media/books:/books

  # Media Server
  plex:
    image: lscr.io/linuxserver/plex:latest
    container_name: plex
    restart: unless-stopped
    network_mode: host
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=${TZ}
      - VERSION=docker
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,video,utility
    volumes:
      - /data/arr/config/plex:/config
      - /data/arr/media:/data
    devices:
      - /dev/dri:/dev/dri  # Intel/AMD hardware acceleration fallback
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]

  # Request Management
  overseerr:
    image: lscr.io/linuxserver/overseerr:latest
    container_name: overseerr
    restart: unless-stopped
    ports:
      - "5055:5055"
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=${TZ}
    volumes:
      - /data/arr/config/overseerr:/config

  ## JELLYFIN BACKUP (commented out - switch back if needed)
  # jellyfin:
  #   image: lscr.io/linuxserver/jellyfin:latest
  #   container_name: jellyfin
  #   restart: unless-stopped
  #   ports:
  #     - "8096:8096"
  #     - "8920:8920"   # HTTPS
  #   environment:
  #     - PUID=1000
  #     - PGID=1000
  #     - TZ=${TZ}
  #     - NVIDIA_VISIBLE_DEVICES=all
  #     - NVIDIA_DRIVER_CAPABILITIES=compute,video,utility
  #   volumes:
  #     - /data/arr/config/jellyfin:/config
  #     - /data/arr/media:/data
  #   devices:
  #     - /dev/dri:/dev/dri  # Intel/AMD hardware acceleration fallback
  #   deploy:
  #     resources:
  #       reservations:
  #         devices:
  #           - driver: nvidia
  #             count: 1
  #             capabilities: [gpu]

  ## JELLYSEERR BACKUP (commented out - switch back if needed)
  # jellyseerr:
  #   image: fallenbagel/jellyseerr:latest
  #   container_name: jellyseerr
  #   restart: unless-stopped
  #   ports:
  #     - "5055:5055"
  #   environment:
  #     - PUID=1000
  #     - PGID=1000
  #     - TZ=${TZ}
  #   volumes:
  #     - /data/arr/config/jellyseerr:/app/config

networks:
  default:
    name: arr_network